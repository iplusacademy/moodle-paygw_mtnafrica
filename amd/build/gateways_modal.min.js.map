{"version":3,"file":"gateways_modal.min.js","sources":["../src/gateways_modal.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is responsible for MTN Africa content in the gateways modal.\n *\n * @copyright  2023 Medical Access Uganda\n * @author     Renaat Debleu <info@eWallah.net>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Repository from './repository';\nimport Templates from 'core/templates';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport {get_string as getString} from 'core/str';\n\n/**\n * Creates and shows a modal that contains a placeholder.\n *\n * @returns {Promise<Modal>}\n */\nconst showModalWithPlaceholder = async() => {\n    const modal = await ModalFactory.create({\n        body: await Templates.render('paygw_mtnafrica/placeholder', {})\n    });\n    modal.show();\n    return modal;\n};\n\n/**\n * Process the payment.\n *\n * @param {string} component Name of the component that the itemId belongs to\n * @param {string} paymentArea The area of the component that the itemId belongs to\n * @param {number} itemId An internal identifier that is used by the component\n * @param {string} description Description of the payment\n * @returns {Promise<string>}\n */\nexport const process = (component, paymentArea, itemId, description) => {\n    return Promise.all([\n        showModalWithPlaceholder(),\n        Repository.getConfigForJs(component, paymentArea, itemId),\n    ])\n    .then(([modal, mtnConfig]) => {\n        modal.setTitle(getString('pluginname', 'paygw_mtnafrica'));\n        console.log(description);  // eslint-disable-line\n        const phoneNumber = modal.getRoot().find('#mtn-phone');\n        phoneNumber.append('<h4>' + mtnConfig.phone + '</h4>');\n        const userCountry = modal.getRoot().find('#mtn-country');\n        userCountry.append('<h4>' + mtnConfig.usercountry + '</h4>');\n        const extraDiv = modal.getRoot().find('#mtn-extra');\n        extraDiv.append('<h4>' + mtnConfig.cost + ' ' + mtnConfig.currency + '</h4>');\n        const payForm = modal.getRoot().find('#mtn-form');\n        payForm.append('<input type=\"hidden\" name=\"userid\" value=\"' + mtnConfig.userid + '\" />');\n        payForm.append('<input type=\"hidden\" name=\"phone\" value=\"' + mtnConfig.phone + '\" />');\n        payForm.append('<input type=\"hidden\" name=\"country\" value=\"' + mtnConfig.country + '\" />');\n        payForm.append('<input type=\"hidden\" name=\"component\" value=\"' + component + '\" />');\n        payForm.append('<input type=\"hidden\" name=\"paymentarea\" value=\"' + paymentArea + '\" />');\n        payForm.append('<input type=\"hidden\" name=\"itemid\" value=\"' + itemId + '\" />');\n        payForm.append('<input type=\"hidden\" name=\"description\" value=\"' + description + '\" />');\n        payForm.append('<input type=\"hidden\" name=\"reference\" value=\"' + mtnConfig.reference + '\" />');\n        modal.getRoot().on(ModalEvents.hidden, () => {\n            // Destroy when hidden.\n            console.log('Destroy modal');  // eslint-disable-line\n            modal.destroy();\n        });\n\n        return Promise.all([modal, mtnConfig]);\n    })\n    .then(([modal, mtnConfig]) => {\n        const cancelButton = modal.getRoot().find('#mtn-cancel');\n        cancelButton.on('click', function() {\n            modal.destroy();\n        });\n        const payButton = modal.getRoot().find('#mtn-pay');\n        payButton.removeAttr('disabled');\n        payButton.on('click', function(e) {\n            e.preventDefault();\n            modal.setBody(Templates.render('paygw_mtnafrica/busy', {}));\n\n            return Promise.all([\n                Repository.transactionStart(component, paymentArea, itemId, mtnConfig.reference, mtnConfig.phone, mtnConfig.country)\n            ])\n            .then(([mtnPay]) => {\n                const cancelButton1 = modal.getRoot().find('#mtn-cancel');\n                cancelButton1.on('click', function() {\n                    modal.destroy();\n                });\n                if (mtnPay.code == 200) {\n                    console.log('mtn Africa payment process started');  // eslint-disable-line\n                    console.log('TransactionId: ' + mtnPay.xreferenceid);  // eslint-disable-line\n                    console.log('Token: ' + mtnPay.token);  // eslint-disable-line\n                    const outDiv = modal.getRoot().find('#mtn-out');\n                    const spinnerDiv = modal.getRoot().find('#mtn-spinner');\n                    outDiv.append('<h4>TransactionId: ' + mtnPay.xreferenceid + '</h4>');\n                    var arrayints = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];\n                    var interval = 20000;\n                    const b = '</div>';\n                    const progressDiv = modal.getRoot().find('#mtn-progress_bar');\n                    arrayints.forEach(function(el, index) {\n                        setTimeout(function() {\n                            progressDiv.attr('value', el * 10);\n                            if (mtnPay.xreferenceid != '') {\n                                modal.setFooter('Step ' + el + '/10');\n                                Promise.all([\n                                    Repository.transactionComplete(\n                                        component, paymentArea, itemId, mtnPay.transactionid, mtnConfig.userid, mtnPay.token),\n                                ])\n                                .then(([mtnPing]) => {\n                                    modal.setFooter(mtnPing.message);\n                                    console.log(mtnPing.message);  // eslint-disable-line\n                                    if (mtnPing.success) {\n                                        if (mtnPing.message == 'SUCCESSFUL') {\n                                            const a = '<br/><div class=\"p-3 mb-2 text-success font-weight-bold\">';\n                                            outDiv.append(a + mtnPing.message + b);\n                                            const payButton1 = modal.getRoot().find('#mtn-pay');\n                                            payButton1.removeAttr('disabled');\n                                            payButton1.on('click', function() {\n                                                modal.destroy();\n                                            });\n                                            spinnerDiv.attr('style', 'display: none;');\n                                            cancelButton1.attr('style', 'display: none;');\n                                            return;\n                                        }\n                                    } else {\n                                        const a = '<br/><div class=\"p-3 mb-2 bg-danger text-white font-weight-bold\">';\n                                        outDiv.append(a + mtnPing.message + b);\n                                        spinnerDiv.attr('style', 'display: none;');\n                                        return;\n                                    }\n                                });\n                            }\n                            if (el == 10) {\n                                modal.destroy();\n                            }\n                        }, index * interval);\n                    });\n                } else {\n                    console.log('mtn Africa transaction FAILED');  // eslint-disable-line\n                    modal.setFooter('FAILED');\n                }\n            }).catch(e => {\n                // We want to use promise reject here - as that's what core payment stuff expects.\n                console.log('mtn Africa payment rejected');  // eslint-disable-line\n                return Promise.reject(e.message);\n            });\n        });\n        return new Promise(() => null);\n    }).catch(e => {\n        return Promise.reject(e.message);\n    });\n};\n"],"names":["showModalWithPlaceholder","async","modal","ModalFactory","create","body","Templates","render","show","component","paymentArea","itemId","description","Promise","all","Repository","getConfigForJs","then","_ref","mtnConfig","setTitle","console","log","getRoot","find","append","phone","usercountry","cost","currency","payForm","userid","country","reference","on","ModalEvents","hidden","destroy","_ref2","payButton","removeAttr","e","preventDefault","setBody","transactionStart","_ref3","mtnPay","cancelButton1","code","xreferenceid","token","outDiv","spinnerDiv","b","progressDiv","forEach","el","index","setTimeout","attr","setFooter","transactionComplete","transactionid","_ref4","mtnPing","message","success","a","payButton1","catch","reject"],"mappings":"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"}