{"version":3,"file":"gateways_modal.min.js","sources":["../src/gateways_modal.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is responsible for MTN Africa content in the gateways modal.\n *\n * @copyright  2023 Medical Access Uganda\n * @author     Renaat Debleu <info@eWallah.net>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Repository from './repository';\nimport Ajax from 'core/ajax';\nimport Config from 'core/config';\nimport Log from 'core/log';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Templates from 'core/templates';\nimport {get_string as getString} from 'core/str';\n\n/**\n * Creates and shows a modal that contains a placeholder.\n *\n * @returns {Promise<Modal>}\n */\nconst showModalWithPlaceholder = async() => {\n    const modal = await ModalFactory.create({\n        body: await Templates.render('paygw_mtnafrica/placeholder', {})\n    });\n    modal.show();\n    return modal;\n};\n\n/**\n * Process the payment.\n *\n * @param {string} component Name of the component that the itemId belongs to\n * @param {string} paymentArea The area of the component that the itemId belongs to\n * @param {number} itemId An internal identifier that is used by the component\n * @param {string} description Description of the payment\n * @returns {Promise<string>}\n */\nexport const process = (component, paymentArea, itemId, description) => {\n    return Promise.all([\n        showModalWithPlaceholder(),\n        Repository.getConfigForJs(component, paymentArea, itemId),\n    ])\n    .then(([modal, mtnConfig]) => {\n        modal.setTitle(getString('pluginname', 'paygw_mtnafrica'));\n        console.log(description);  // eslint-disable-line\n        const phoneNumber = modal.getRoot().find('#mtn-phone');\n        phoneNumber.append('<h4>' + mtnConfig.phone + '</h4>');\n        const userCountry = modal.getRoot().find('#mtn-country');\n        userCountry.append('<h4>' + mtnConfig.usercountry + '</h4>');\n        const extraDiv = modal.getRoot().find('#mtn-extra');\n        extraDiv.append('<h4>' + mtnConfig.cost + ' ' + mtnConfig.currency + '</h4>');\n        modal.getRoot().on(ModalEvents.hidden, () => {\n            // Destroy when hidden.\n            console.log('Destroy modal');  // eslint-disable-line\n            modal.destroy();\n        });\n\n        return Promise.all([modal, mtnConfig]);\n    })\n    .then(([modal, mtnConfig]) => {\n        var cancelButton = modal.getRoot().find('#mtn-cancel');\n        cancelButton.on('click', function() {\n            modal.destroy();\n        });\n        var payButton = modal.getRoot().find('#mtn-pay');\n        payButton.removeAttr('disabled');\n        payButton.on('click', function(e) {\n            e.preventDefault();\n            Promise.all([\n                Repository.transactionStart(component, paymentArea, itemId),\n            ])\n            .then(([mtnPay]) => {\n                const transId = mtnPay.transactionid;\n                modal.setBody(Templates.render('paygw_mtnafrica/busy', {\n                    \"sesskey\": Config.sesskey,\n                    \"phone\": mtnConfig.phone,\n                    \"country\": mtnConfig.country,\n                    \"component\": component,\n                    \"paymentarea\": paymentArea,\n                    \"transactionid\": transId,\n                    \"itemid\": itemId,\n                    \"description\": description,\n                    \"reference\": mtnConfig.reference,\n                }));\n                cancelButton = modal.getRoot().find('#mtn-cancel');\n                cancelButton.on('click', function() {\n                    e.preventDefault();\n                    modal.destroy();\n                });\n                payButton = modal.getRoot().find('#mtn-pay');\n                payButton.on('click', function() {\n                    modal.destroy();\n                });\n                console.log('mtn Africa payment process started');  // eslint-disable-line\n                console.log('Reference id: ' + transId);  // eslint-disable-line\n                var arrayints = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];\n                var interval = mtnConfig.timeout;\n                var cont = true;\n                const b = '</div>';\n                arrayints.forEach(function(el, index) {\n                    setTimeout(function() {\n                        if (cont == true) {\n                            var progressDiv = modal.getRoot().find('#mtn-progress_bar');\n                            progressDiv.attr('value', el * 10);\n                            if (mtnPay.xreferenceid != '') {\n                                Ajax.call([{\n                                    methodname: \"paygw_mtnafrica_transaction_complete\",\n                                    args: {\n                                        component,\n                                        paymentarea: paymentArea,\n                                        itemid: itemId,\n                                        xreferenceid: transId,\n                                    },\n                                    done: function(mtnPing) {\n                                        modal.setFooter(el + '/10 ' + mtnPing.message);\n                                        console.log(el + '/10 ' + mtnPing.message);  // eslint-disable-line\n                                        var spinnerDiv = modal.getRoot().find('#mtn-spinner');\n                                        if (mtnPing.success) {\n                                            if (mtnPing.message == 'SUCCESSFUL') {\n                                                cont = false;\n                                                progressDiv.attr('value', 100);\n                                                spinnerDiv.attr('style', 'display: none;');\n                                                var cancelButton = modal.getRoot().find('#mtn-cancel');\n                                                cancelButton.attr('style', 'display: none;');\n                                                modal.setFooter('Transaction '+ transId + ' Succes');\n                                                payButton.on('click', function() {\n                                                    const loc = window.location.href;\n                                                    window.location.replace(loc);\n                                                });\n                                            }\n                                        } else {\n                                            cont = false;\n                                            const a = '<br/><div class=\"p-3 mb-2 bg-danger text-white font-weight-bold\">';\n                                            var outDiv = modal.getRoot().find('#mtn-out');\n                                            outDiv.append(a + mtnPing.message + b);\n                                            spinnerDiv.attr('style', 'display: none;');\n                                            return;\n                                        }\n                                    },\n                                    fail: function(e) {\n                                        console.log(getString('failed', 'paygw_mtnafrica'));  // eslint-disable-line\n                                        Log.debug(e);\n                                    }\n                                }]);\n                                if (el > 9) {\n                                    modal.destroy();\n                                }\n                            }\n                        }\n                    }, index * interval);\n                });\n                return new Promise(() => null);\n            }).catch(function() {\n                modal.setBody(getString('unable', 'paygw_mtnafrica'));\n                console.log('Unable to connect to MTN');  // eslint-disable-line\n            });\n        });\n        return new Promise(() => null);\n    }).catch(e => {\n        Log.debug('Global error.');\n        Log.debug(e);\n        return Promise.reject(e.message);\n    });\n};\n"],"names":["showModalWithPlaceholder","async","modal","ModalFactory","create","body","Templates","render","show","component","paymentArea","itemId","description","Promise","all","Repository","getConfigForJs","then","_ref","mtnConfig","setTitle","console","log","getRoot","find","append","phone","usercountry","cost","currency","on","ModalEvents","hidden","destroy","_ref2","cancelButton","payButton","removeAttr","e","preventDefault","transactionStart","_ref3","mtnPay","transId","transactionid","setBody","Config","sesskey","country","reference","interval","timeout","cont","forEach","el","index","setTimeout","progressDiv","attr","xreferenceid","call","methodname","args","paymentarea","itemid","done","mtnPing","setFooter","message","spinnerDiv","success","a","loc","window","location","href","replace","fail","debug","catch","reject"],"mappings":"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"}