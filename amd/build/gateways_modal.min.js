define("paygw_mtnafrica/gateways_modal",["exports","./repository","core/ajax","core/config","core/log","core/modal_factory","core/modal_events","core/templates","core/str"],(function(_exports,Repository,_ajax,_config,_log,_modal_factory,_modal_events,_templates,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.process=void 0,Repository=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}
/**
   * This module is responsible for MTN Africa content in the gateways modal.
   *
   * @copyright  Medical Access Uganda Limited (e-learning.medical-access.org)
   * @author     Renaat Debleu <info@eWallah.net>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */(Repository),_ajax=_interopRequireDefault(_ajax),_config=_interopRequireDefault(_config),_log=_interopRequireDefault(_log),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_templates=_interopRequireDefault(_templates);const showModalWithPlaceholder=async()=>{const modal=await _modal_factory.default.create({body:await _templates.default.render("paygw_mtnafrica/placeholder",{})});return modal.show(),modal};_exports.process=(component,paymentArea,itemId,description)=>Promise.all([showModalWithPlaceholder(),Repository.getConfigForJs(component,paymentArea,itemId)]).then((_ref=>{let[modal,mtnConfig]=_ref;modal.setTitle((0,_str.get_string)("pluginname","paygw_mtnafrica")),console.log(description);modal.getRoot().find("#mtn-phone").append("<h4>"+mtnConfig.phone+"</h4>");modal.getRoot().find("#mtn-country").append("<h4>"+mtnConfig.usercountry+"</h4>");return modal.getRoot().find("#mtn-extra").append("<h4>"+mtnConfig.cost+" "+mtnConfig.currency+"</h4>"),modal.getRoot().on(_modal_events.default.hidden,(()=>{console.log("Destroy modal"),modal.destroy()})),Promise.all([modal,mtnConfig])})).then((_ref2=>{let[modal,mtnConfig]=_ref2;var cancelButton=modal.getRoot().find("#mtn-cancel");cancelButton.on("click",(function(){modal.destroy()}));var payButton=modal.getRoot().find("#mtn-pay");return payButton.removeAttr("disabled"),payButton.on("click",(function(e){e.preventDefault(),Promise.all([Repository.transactionStart(component,paymentArea,itemId)]).then((_ref3=>{let[mtnPay]=_ref3;const transId=mtnPay.transactionid;modal.setBody(_templates.default.render("paygw_mtnafrica/busy",{sesskey:_config.default.sesskey,phone:mtnConfig.phone,country:mtnConfig.country,component:component,paymentarea:paymentArea,transactionid:transId,itemid:itemId,description:description,reference:mtnConfig.reference})),(cancelButton=modal.getRoot().find("#mtn-cancel")).on("click",(function(){e.preventDefault(),modal.destroy()})),(payButton=modal.getRoot().find("#mtn-pay")).on("click",(function(){modal.destroy()})),payButton.attr("disabled",""),console.log("mtn Africa payment process started"),console.log("Reference id: "+transId);var interval=mtnConfig.timeout,cont=!0;return[1,2,3,4,5,6,7,8,9,10].forEach((function(el,index){setTimeout((function(){if(1==cont){var progressDiv=modal.getRoot().find("#mtn-progress_bar");progressDiv.attr("value",10*el),""!=mtnPay.xreferenceid&&(_ajax.default.call([{methodname:"paygw_mtnafrica_transaction_complete",args:{component:component,paymentarea:paymentArea,itemid:itemId,xreferenceid:transId},done:function(mtnPing){modal.setFooter(el+"/10 "+mtnPing.message),console.log(el+"/10 "+mtnPing.message);var spinnerDiv=modal.getRoot().find("#mtn-spinner");if(!mtnPing.success){cont=!1;const a='<br/><div class="p-3 mb-2 bg-danger text-white font-weight-bold">';return modal.getRoot().find("#mtn-out").append(a+mtnPing.message+"</div>"),void spinnerDiv.attr("style","display: none;")}if("SUCCESSFUL"==mtnPing.message){cont=!1,progressDiv.attr("value",100),spinnerDiv.attr("style","display: none;"),modal.getRoot().find("#mtn-cancel").attr("style","display: none;");var payButton=modal.getRoot().find("#mtn-pay");payButton.removeAttr("disabled"),modal.setFooter("Transaction "+transId+" Succes"),payButton.on("click",(function(){const loc=window.location.href;window.location.replace(loc)}))}},fail:function(e){console.log((0,_str.get_string)("failed","paygw_mtnafrica")),_log.default.debug(e)}}]),el>9&&modal.destroy())}}),index*interval)})),new Promise((()=>null))})).catch((function(){modal.setBody((0,_str.get_string)("unable","paygw_mtnafrica")),console.log("Unable to connect to MTN")}))})),new Promise((()=>null))})).catch((e=>(_log.default.debug("Global error."),_log.default.debug(e),Promise.reject(e.message))))}));

//# sourceMappingURL=gateways_modal.min.js.map